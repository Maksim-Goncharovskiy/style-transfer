# Online-NST, алгоритм Гатиса
## 1. Определения и формулировка задачи
**ОПР.** `NST` - neural style transfering, перенос стиля c использованием нейронных сетей.
**Формулировка задачи:**
Даны два входных изображения:
- `C` - изображение контента, содержание
- `S` - изображение стиля, который должен быть применён к C
**Задача:** получить изображение `G` с содержанием из `C` и стилем из `S`.
## 2. Online NST
Основная идея:
1. Берётся предобученная свёрточная нейронная сеть, которая будет извлекать из изображений значимые карты признаков(Обычно это сеть VGG). Её слои замораживаются, веса сети оптимизироваться не будут.
2. При помощи нейросети извлекается набор из карт признаков для изображений `C` и `S`.
3. Инициализируем как-то выходное изображение `G` (можно взять просто `C`, можно сделать зашумлённую версию `C`, можно случайными значениями).
4. Выполняется оптимизацию функции потерь в пространстве изображения `G`: при помощи нейросети получается набор из карт признаков для `G` и считается потеря между получившимися картами признаков и полученными картами признаков для `C` и `S`. (про функцию потерь см. ниже)

### Функция потерь
Функция потерь в задаче стилизации состоит из двух частей:
1. Потеря контента: $L_{content}$
2. Потеря стиля: $L_{style}$
Итоговая функция потерь принимает вид: $L = \alpha*L_{content} + \beta*L_{style}$

В качестве потери контента отлично подойдёт `MSELoss`, а вот для переноса стиля она подойдёт не очень: в контенте нам важно расположение объектов, положение линий, а в стиле нам важна общая концепция, а не точное совпадение пикселей.

В качестве потери стиля используется `MSELoss` между матрицами Грамма для карты признаков `S` и карты признаков `G`. 

Что такое матрица Грамма?
Матрица Грамма - это квадратная матрица, составленная для системы векторов и состоящая из всех возможных попарных скалярных произведений этих векторов. 

Допустим выходом некоторого слоя свёрточной сети является набор карт активаций: NxWxH . Тогда получаем систему из N векторов размерности WxH, для которой рассчитывается матрица Грамма NxN.

Таким образом матрица Грамма считается в n-ом слое сети для `G` и для `S` и потеря стиля на этом выходе сети будет равна MSELoss между этими двумя матрицами Грамма. 

## 3. Архитектура решения
![[online-nst.png]]
Берём несколько первых слоёв сети VGG19, определяем на каких слоях будем считать потерю контента, а на каких потерю стиля(на одном слое можно считать обе потери). Конструируем собственную модель состоящую из:
1. Слой нормализации изображений (должен идти первым, т.к. VGG обучалась на изображениях с определёнными средними значениями и стандартными отклонениями).
2. Первые слои VGG19.
3. Слои потерь, которые содержат поле self.loss, где значение потери на последней итерации оптимизации. 
